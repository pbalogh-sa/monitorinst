- name: Install thruk
  debug: msg="Install Thruk"

- apt: name='{{ item }}' state=present
  with_items:
    - phantomjs
    - libjson-perl
    - libplack-perl
    - libfile-slurp-perl
    - libdate-calc-perl
    - libtemplate-perl
    - liblog-log4perl-perl
    - libmime-lite-perl

- get_url: url="http://download.thruk.org/pkg/v2.08/src/thruk-2.08.tar.gz" dest=/home/{{ actinguser }}/tmp/thruk.tar.gz
  become: yes

- command: tar -xf /home/{{ actinguser }}/tmp/thruk.tar.gz -C /home/{{ actinguser }}/app
  become: yes

- command: creates="/home/{{ actinguser }}/app/thruk" mv /home/{{ actinguser }}/app/thruk-2.08 /home/{{ actinguser }}/app/thruk
  become: yes

- template: src=thruk_local.conf.template dest=/home/{{ actinguser }}/etc/mars/thruk_local.conf

- file: src=/home/{{ actinguser }}/etc/mars/thruk_local.conf dest=/home/{{ actinguser }}/app/thruk/thruk_local.conf state=link
  become: yes

- synchronize: src=/home/{{ actinguser }}/etc/mars/thruk_local.conf dest={{ corpPath }}/{{ nodeColoc }}/{{ ansible_nodename }}/home/{{ actinguser }}/etc/mars/thruk_local.conf mode=pull

- local_action: shell chdir={{ corpPath }}/{{ nodeColoc }}/{{ ansible_nodename }}/home/{{ actinguser }}/etc/mars cvs add {{ item }}
  with_items:
    - ./thruk_local.conf
  tags:
    - cvscommit
    - cvsadd
  ignore_errors: yes

- local_action: |
    shell chdir={{ corpPath }}/{{ nodeColoc }}/{{ ansible_nodename }}/home/{{ actinguser }}/etc/mars cvs commit -m "Ansible shinken/mars
    Initial commit" {{ item }}
  with_items:
    - ./thruk_local.conf
  tags:
    - cvscommit

#- name: Start thruk
#  command: daemon -n grafana -D /home/{{ actinguser }}/app/thruk -r -- /home/{{ actinguser }}/app/thruk/scripts/thruk_server.pl -p 9790
